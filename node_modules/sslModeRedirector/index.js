var url = require('url');

route = function(env_settings, sslmode) {

  return function route(req, res, next) {

    if ((req.url.lastIndexOf('.html') == (req.url.length - 5)) || (req.url.slice(-1) == '/')) {
      // console.log('New html page being requested: ' + req.url);

      if (sslmode == 'NONSSL') {

        if ((req.url.indexOf('/ops/') == 0) || (req.url.indexOf('/secure/') == 0)) {
          console.log('Secure request made not in SSL: ' + req.url);
          console.log('Redirecting to https://' + env_settings.host + ':' + env_settings.sslport + req.url);
          res.writeHead(301,
            {Location: 'https://' + env_settings.host + ':' + env_settings.sslport + req.url}
          );
          res.end();
          return;
        } else {
          next();
          return;
        }

      } else {

        if ((req.url.indexOf('/ops/') != 0) && (req.url.indexOf('/secure/') != 0)) {
          console.log('SSL request made to non-secure resource: ' + req.url);
          console.log('Redirecting to http://' + env_settings.host + ':' + env_settings.port + req.url);
          res.writeHead(301,
            {Location: 'http://' + env_settings.host + ':' + env_settings.port + req.url}
          );
          res.end();
          return;
        } else {
          next();
          return;
        }

      }

    } else {
      next();
      return;
    }

  }

}

/* Expose public functions ------ */
exports.route = route;

