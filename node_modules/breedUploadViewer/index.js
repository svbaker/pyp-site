var mysql = require('mysql');
var fs = require('fs');

servePage = function(env_settings) {

  return function servePage(req, res, next) {

    // Pass to next Connect module if URL is not breed viewer page
    if (req.url.length > 14) {
      if (req.url.toLowerCase().substring(0, 15) != '/ops/viewbreed/') {
        next();
        return;
      }
    } else {
      next();
      return;
    }

    var breed_id = req.url.substring(15, req.url.length);
    //console.log('View Breed id is: ' + breed_id);

    // Set up general variables
    var connectionInfo = env_settings.dbConnSettings;
    var connection;

  	var page_content = '<!DOCTYPE html><html><head><title>PYP OPS - View breed uploads</title>';
  	page_content += '<link rel="shortcut icon" href="/images/favicon.ico">\n';
  	page_content += '<script type="text/javascript" src="/js/jquery-1.8.2.min.js" ></script>';

    page_content += '<style>\n';
    page_content += '* {margin:0;padding:0;}\n';
    page_content += 'p {clear: both; padding: 0;}\n';
    page_content += 'div {white-space:nowrap; width: 600px;}\n';
    page_content += 'label {display: block; float: left; width: 120px; padding: 2px 10px 2px 2px; text-align: right;}\n';

    page_content += '.photo-container {\n';
    page_content += 'border: 1px solid #dedede;\n';
    page_content += 'height: 68px;\n';
    page_content += 'width: 87px;\n';
    page_content += 'background-position: center;\n';
    page_content += 'background-size: cover;\n';
    page_content += 'float: left;}\n';

    page_content += '</style>\n';

    page_content += '</head>\n';
    page_content += '<body>\n';

    // ---- Page Content ---------------
    page_content += '<h2>Breed uploads for breed ID ' + breed_id + '</h2><hr>';

    connection = mysql.createConnection(connectionInfo);
    sql = 'SELECT * FROM posts WHERE breed_id = ' + connection.escape(parseInt(breed_id)) + ' ORDER BY post_date';

    /*
    connection.query(sql, function(err, rows, fields) {
      if (err) throw err;
      for (var i = 0; i < rows.length; i++) {
        page_content += '<p><label>Post ID:</label><div>' + rows[i].id + '</div></p>';
        page_content += '<p><label>Full Name:</label><div>' + rows[i].full_name + '</div></p>';
        page_content += '<p><label>Farm Name:</label><div>' + rows[i].farm_name + '</div></p>';
        page_content += '<p><label>Mailing Address:</label><div>' + rows[i].mailing_address + '</div></p>';
        page_content += '<p><label>Email:</label><div>' + rows[i].email + '</div></p>';
        page_content += '<p><label>Website:</label><div>' + rows[i].website + '</div></p>';
        page_content += '<p><label>Photo Credit:</label><div>' + rows[i].photo_credit + '</div></p>';
        page_content += '<p><label>Breed Description:</label><div>' + rows[i].breed_description + '</div></p>';
        page_content += '<p><label>Breed Personality:</label><div>' + rows[i].breed_personality + '</div></p>';
        page_content += '<p><label>Post Date:</label><div>' + rows[i].post_date + '</div></p>';
        page_content += '<p><label>Browser:</label><div>' + rows[i].agent + '</div></p>';
        page_content += '<br><hr>';
      }
      page_content += '</body></html>\n';
      res.end(page_content);
      return;
    });
    */

    connection.query(sql, function(err, rows, fields) {
      if (err) throw err;
      processRecs(rows);
    });

    function processRecs(rows) {
      if (rows.length == 0) {
        page_content += '</body></html>\n';
        res.end(page_content);
        return;
      } else {
        var this_row = rows.pop();
        page_content += '<p><label>Post ID:</label><div>' + this_row.id + '</div></p>';
        page_content += '<p><label>Full Name:</label><div>' + this_row.full_name + '</div></p>';
        page_content += '<p><label>Farm Name:</label><div>' + this_row.farm_name + '</div></p>';
        page_content += '<p><label>Mailing Address:</label><div>' + this_row.mailing_address + '</div></p>';
        page_content += '<p><label>Email:</label><div>' + this_row.email + '</div></p>';
        page_content += '<p><label>Website:</label><div>' + this_row.website + '</div></p>';
        page_content += '<p><label>Photo Credit:</label><div>' + this_row.photo_credit + '</div></p>';
        page_content += '<p><label>Breed Description:</label><div>' + this_row.breed_description + '</div></p>';
        page_content += '<p><label>Breed Personality:</label><div>' + this_row.breed_personality + '</div></p>';
        page_content += '<p><label>Post Date:</label><div>' + this_row.post_date + '</div></p>';
        page_content += '<p><label>Browser:</label><div>' + this_row.agent + '</div></p>';
        
        page_content += '<p><label>Photos:</label><div>'

        sql = 'SELECT web_path FROM photo_uploads WHERE post_id = ' + connection.escape(parseInt(this_row.id));
        connection.query(sql, function(err2, rows2, fields2) {
          if (err2) throw err;
          processPhotos(rows2);
        });

        function processPhotos(rows2) {
          if (rows2.length == 0) {
            page_content += '</div></p><br><hr>';
            processRecs(rows);
          } else {
            var thisImage = rows2.pop();
            page_content += formatImage(thisImage.web_path);
            processPhotos(rows2);
          }
        }

      }
    }

  }

}


function formatImage(web_path) {
  var output = '';
  output += '<div onclick="window.open(\'' + web_path + '\');" class="photo-container" style="';
  output += 'background: url(' + web_path + ') no-repeat left top;';
  output += 'background-position: center;';
  output += 'background-size: cover;';
  output += '"></div>';
  return output;
}



/* Expose public functions ------ */
exports.servePage = servePage;